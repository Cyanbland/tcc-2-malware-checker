import os
import time
import requests
import streamlit as st
import cookies
from sidebar import sidebar

def authenticate_user(email, password):
    api_endpoint = os.getenv("API_ENDPOINT") + '/auth/login'

    jwt = ""

    payload = {
        "email": email,
        "password": password
    }

    try:
        response = requests.post(api_endpoint, json=payload)
        resp = response.json()

        if response.status_code == 200:
            st.success("Login Successful!")
            jwt = resp["access_token"]

        else:
            errors = resp["message"]
            print(errors)

            if type(errors) == list:
                for er in errors:
                    st.error(er)
            else:
                st.error(errors)
            st.error("Login failed. Please try again.")

        return jwt

    except Exception as e:
        print("Error occurred during API call:", e)
        st.error("Login failed. Please try again.")

# Login Page
def login():
    sidebar()

    if st.session_state.auth_status != 'Not Authenticated':
        st.warning("Already authenticated as " + st.session_state.auth_status)
        return

    st.title("Login")
    email = st.text_input("Email")
    password = st.text_input("Password", type="password")

    if st.button("Login"):
        if not email:
            st.error("Email can't be empty")
            return
        
        if not password:
            st.error("Password can't be empty")
            return

        jwt = authenticate_user(email, password)
        if jwt:            
            cookies.cookie_manager.updateJWTCookie(jwt)

            st.session_state.auth_status = email.split('@')[0]
            
            time.sleep(1)
            st.switch_page("Home.py")
            


login()
import os
import streamlit as st
import requests
from check_access import check_access_allowed
from sidebar import sidebar
import cookies

def get_profile_info(jwt):
    profile_info = {}

    api_endpoint = os.getenv("API_ENDPOINT") + '/users/me'

    try:
        response = requests.get(api_endpoint, headers = {"Authorization": f"Bearer {jwt}"})
        resp = response.json()

        if response.status_code == 200:
            profile_info = resp
        
        else:
            errors = resp["message"]

            if type(errors) == list:
                for er in errors:
                    st.error(er)
            else:
                st.error(errors)
            st.error("Request failed. Please try again.")

        return profile_info

    except Exception as e:
        print("Error occurred during API call:", e)
        st.error("Error ocurred. Please try again.")

def profile():
    sidebar()
    # check if current jwt is still valid
    if (check_access_allowed()):
        st.title("Profile")

        profile_info = get_profile_info(cookies.cookie_manager.getJWTCookieValue())
        if 'firstName' in profile_info and 'lastName' in profile_info:
            st.header(f"{profile_info['firstName']} {profile_info['lastName']}")
            st.write("Email: " + profile_info["email"])
            st.write("id: " + profile_info["id"])
            st.write("Role: " + profile_info["role"])
        else:
            st.header(profile_info['email'].split('@')[0])
            st.write("id: " + profile_info["id"])
            st.write("Role: " + profile_info["role"])
    
    return

profile()
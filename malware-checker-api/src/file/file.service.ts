import { Injectable, NotAcceptableException, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { PrismaClientKnownRequestError } from '@prisma/client/runtime/library';
import { File, YaraRule, YaraRuleSourcesOnUsers } from '@prisma/client';
import { resolve } from 'path';
import { spawn } from 'child_process';

@Injectable()
export class FileService {
    constructor(private prisma: PrismaService) {}

    private YARA_CLI_PATH = resolve(__dirname, "../../yara")
    
    async addFileToUser(file: Express.Multer.File, email: string) {
        try {
            const user = await this.prisma.user.findUnique({
                where: {
                    email
                }
            })
            
            let data = {
                storedName: file.filename,
                originalName: file.originalname,
                type: file.mimetype,
                length: file.size,
                location: file.path,
                userId: user.id
            }
            
            const createdFile = await this.prisma.file.create({data})
            delete createdFile.location
            return createdFile
        }
        catch(error) {
            if (error instanceof PrismaClientKnownRequestError) {
                throw new NotAcceptableException(error.message)
            }
        }
    }

    // list all files from user
    async getFilesFromUser(email: string) {
        try {
            const user = await this.prisma.user.findUnique({
                where: {
                    email
                }
            })

            const files = await this.prisma.file.findMany({ 
                where: {
                    userId: user.id
                },
                orderBy: {
                    createdAt: 'desc'
                }
            })

            return files
        }
        catch(error) {
            if (error instanceof PrismaClientKnownRequestError) {
                throw new NotFoundException(error.message)
            }
        }
    }

    async analyzeFileWithSubscribedYaraSources(email: string, fileId: string) {
        try {
            const file = await this.prisma.file.findUnique({
                where: {
                    id: fileId
                }
            })

            const user = await this.prisma.user.findUnique({
                where: {
                    email
                }
            })

            const subscribedYaraSources = await this.prisma.yaraRuleSourcesOnUsers.findMany({
                where: {
                    userId: user.id,
                }
            })

            
            
            subscribedYaraSources.forEach(async (source: YaraRuleSourcesOnUsers) => {
                const rulesWithSource = await this.prisma.yaraRuleSource.findMany({
                    select: {
                        name: true,
                        rules: true
                    },
                    where: {
                        id: source.sourceId
                    }
                })
                console.log(rulesWithSource)
                let analys_result = {
                    sources_triggered: [],
                    triggered_rules: []
                }
                rulesWithSource.forEach(async (current_source) => {
                    const {name, rules } = current_source
                    rules.forEach((rule: YaraRule) => {
                        let current_analysis = this.runYaraRulesOnFileObject(rule, file)
                        // append current analysis and update the file obj on DB
                    })
                })
            })

            //return file object with updated characteristics

            return true
        }
        catch(error) {
            if (error instanceof PrismaClientKnownRequestError) {
                throw new NotFoundException(error.message)
            }
        }
    }

    async analyzeFileWithSpecificSource(fileId: string, sourceId: string) {

    }

    async runYaraRulesOnFileObject(rule: YaraRule, file: File) {
        let yaraCommand =  `./yara64.exe ${rule.path} ../${file.location}` 

        let detections = []

        try {
            const ex = spawn(yaraCommand)

            ex.stdout.on("data", data => {
                console.log(`stdout: ${data}`);
                detections.push(data)
            });
            
            ex.stderr.on("data", data => {
                console.log(`stderr: ${data}`);
            });
            
            ex.on('error', (error) => {
                console.log(`error: ${error.message}`);
            });
            
            ex.on("close", code => {
                //console.log(`child process exited with code ${code}`);
            });
        }
        catch(error) {
            if (error instanceof PrismaClientKnownRequestError) {
                throw new NotFoundException(error.message)
            }
        }
    }
}


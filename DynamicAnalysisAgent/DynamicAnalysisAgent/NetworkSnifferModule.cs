using System.Diagnostics;
using System.Text.RegularExpressions;
using PacketDotNet;
using SharpPcap;

namespace DynamicAnalysisAgent
{
    internal class NetworkSnifferModule
    {
        private List<string> detectedURLs = new List<string>();
        private List<string> detectedIPs = new List<string>();
        private ICaptureDevice device;

        public NetworkSnifferModule(int deviceIndex)
        {
            var devices = CaptureDeviceList.Instance;
            if (deviceIndex < 0 || deviceIndex >= devices.Count)
            {
                throw new ArgumentException("Invalid device index.");
            }

            device = devices[deviceIndex];
        }

        public void Start()
        {
            if (device == null)
            {
                throw new InvalidOperationException("No capture device selected.");
            }


            device.OnPacketArrival += new PacketArrivalEventHandler(device_OnPacketArrival);
            device.Open(DeviceModes.Promiscuous);
            device.StartCapture();
        }

        public void Stop()
        {
            if (device != null && device.Started)
            {
                device.StopCapture();
                device.Close();
            }
        }

        private void device_OnPacketArrival(object sender, PacketCapture e)
        {

            var time = e.Header.Timeval.Date;
            var len = e.Data.Length;
            var rawPacket = e.GetPacket();

            var packet = Packet.ParsePacket(rawPacket.LinkLayerType, rawPacket.Data);


            var tcpPacket = packet.Extract<TcpPacket>();
            if (tcpPacket != null)
            {
                var ipPacket = (IPPacket)tcpPacket.ParentPacket;
                System.Net.IPAddress srcIp = ipPacket.SourceAddress;
                System.Net.IPAddress dstIp = ipPacket.DestinationAddress;
                
                int srcPort = tcpPacket.SourcePort;
                int dstPort = tcpPacket.DestinationPort;

                var data = tcpPacket.PayloadData;
                string dataStr = System.Text.Encoding.UTF8.GetString(data);
                Debug.WriteLine(dstIp);

                var urlMatches = Regex.Matches(dataStr, @"http[s]?:\/\/[^\s]+");

                foreach (Match match in urlMatches)
                {
                    var url = match.Value;
                    if (!detectedURLs.Contains(url))
                    {
                        detectedURLs.Add(url);
                        Debug.WriteLine($"Detected URL: {url}");
                    }
                }

                var ipMatches = Regex.Matches(dataStr, @"\b(?:\d{1,3}\.){3}\d{1,3}\b");

                foreach (Match match in ipMatches)
                {
                    var ip = match.Value;
                    if (!detectedIPs.Contains(ip))
                    {
                        detectedIPs.Add(ip);
                        Debug.WriteLine($"Detected IP: {ip}");
                    }
                }   
            }

            var udpPacket = packet.Extract<UdpPacket>();

            if (udpPacket != null)
            {
                Console.WriteLine("Original UDP packet: " + udpPacket.ToString());

                var data = udpPacket.PayloadData;
                string dataStr = System.Text.Encoding.UTF8.GetString(data);

                var urlMatches = Regex.Matches(dataStr, @"http[s]?:\/\/[^\s]+");

                foreach (Match match in urlMatches)
                {
                    var url = match.Value;
                    if (!detectedURLs.Contains(url))
                    {
                        detectedURLs.Add(url);
                        Debug.WriteLine($"Detected URL: {url}");
                    }
                }

                var ipMatches = Regex.Matches(dataStr, @"\b(?:\d{1,3}\.){3}\d{1,3}\b");

                foreach (Match match in ipMatches)
                {
                    var ip = match.Value;
                    if (!detectedIPs.Contains(ip))
                    {
                        detectedIPs.Add(ip);
                        Debug.WriteLine($"Detected IP: {ip}");
                    }
                }
            }

        }

        public List<string> GetDetectedURLs()
        {
            return detectedURLs;
        }

        public List<string> GetDetectedIPs()
        {
            return detectedIPs;
        }
    }
}
